{"version":3,"sources":["services/flowdock.ts"],"names":[],"mappings":"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","file":"flowdock.js","sourcesContent":["/*\nCopyright 2016-2017 Resin.io\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport * as Promise from 'bluebird';\nimport { Session } from 'flowdock';\nimport * as _ from 'lodash';\nimport * as path from 'path';\nimport * as request from 'request-promise';\nimport {\n    DataHub, MessengerEmitResponse, MessengerEvent, ReceiptContext, TransmitContext\n} from '../utils/message-types';\nimport { FlowdockEmitContext, FlowdockHandle, FlowdockMessage } from './flowdock-types';\nimport { MessageService } from './message-service';\nimport { ServiceEmitter, ServiceListener } from './service-types';\n\nexport class FlowdockService extends MessageService implements ServiceEmitter, ServiceListener, DataHub {\n    private static _serviceName = path.basename(__filename.split('.')[0]);\n    private static session = new Session(process.env.FLOWDOCK_LISTENER_ACCOUNT_API_TOKEN);\n\n    /**\n     * Promise to turn the data enqueued into a generic message format\n     * @param data - Raw data from the enqueue, remembering this is as dumb and quick as possible\n     * @returns {Bluebird<ReceiptContext>} - A promise that resolves to the generic form of the event\n     */\n    public makeGeneric(data: MessengerEvent): Promise<ReceiptContext> {\n        // Separate out some parts of the message\n        const metadata = MessageService.extractMetadata(data.rawEvent.content);\n        const titleAndText = metadata.content.match(/^(.*)\\n--\\n((?:\\r|\\n|.)*)$/);\n        const flow = data.cookedEvent.flow;\n        const thread = data.rawEvent.thread_id;\n        const userId = data.rawEvent.user;\n        const org = process.env.FLOWDOCK_ORGANIZATION_NAME;\n        const returnValue: ReceiptContext = {\n            action: 'create',\n            first: data.rawEvent.id === data.rawEvent.thread.initial_message,\n            genesis: metadata.genesis || data.source,\n            hidden: metadata.hidden,\n            source: data.source,\n            sourceIds: {\n                message: data.rawEvent.id,\n                flow,\n                thread,\n                url: `https://www.flowdock.com/app/${org}/${flow}/threads/${thread}`,\n                user: 'duff', // gets replaced\n            },\n            text: titleAndText ? titleAndText[2] : metadata.content,\n            title: titleAndText ? titleAndText[1] : undefined,\n        };\n        // If the data provided a username\n        if (data.rawEvent.external_user_name) {\n            returnValue.sourceIds.user = data.rawEvent.external_user_name;\n            return Promise.resolve(returnValue);\n        }\n        // Attempt to find a username by id\n        return this.fetchFromSession(`/organizations/${org}/users/${userId}`)\n        .then((user) => {\n            returnValue.sourceIds.user = user.nick;\n            return returnValue;\n        });\n    }\n\n    /**\n     * Promise to turn the generic message format into a specific form to be emitted\n     * @param data - Generic message format object to be encoded\n     * @returns {Bluebird<FlowdockEmitContext>} - Promise that resolves to the emit suitable form\n     */\n    public makeSpecific(data: TransmitContext): Promise<FlowdockEmitContext> {\n        // Build a string for the title, if appropriate.\n        const titleText = data.first && data.title ? data.title + '\\n--\\n' : '';\n        return Promise.resolve({\n            // The concatenated string, of various data nuggets, to emit\n            content: MessageService.stringifyMetadata(data) + titleText + data.text,\n            event: 'message',\n            external_user_name:\n                // If this is using the generic token, then they must be an external user, so indicate this\n                data.toIds.token === process.env.FLOWDOCK_LISTENER_ACCOUNT_API_TOKEN\n                ? data.toIds.user.substring(0, 16) : undefined,\n            flow: data.toIds.flow,\n            thread_id: data.toIds.thread,\n            token: data.toIds.token,\n        } as FlowdockEmitContext);\n    }\n\n    /**\n     * Turns the generic, messenger, name for an event into a specific trigger name for this class\n     * @param eventType - Name of the event to translate, eg 'message'\n     * @returns {string} - This class's equivalent, eg 'post'\n     */\n    public translateEventName(eventType: string): string {\n        const equivalents: {[key: string]: string} = {\n            message: 'message',\n        };\n        return equivalents[eventType];\n    }\n\n    /**\n     * Promise to find the comment history of a particular thread\n     * @param thread - id of the thread to search\n     * @param room - id of the room in which the thread resides\n     * @param filter - criteria to match\n     */\n    public fetchNotes(thread: string, room: string, filter: RegExp): Promise<string[]> {\n        // Query the API\n        const org = process.env.FLOWDOCK_ORGANIZATION_NAME;\n        return this.fetchFromSession(`/flows/${org}/${room}/threads/${thread}/messages`)\n        .then((messages) => {\n            return _.map(messages, (value: FlowdockMessage) => {\n                // Clean the response to just the content\n                return value.content;\n            }).filter((value: string) => {\n                // Filter the response to just matches\n                const match = value.match(filter);\n                return match !== null && match.length > 0;\n            });\n        });\n    }\n\n    /**\n     * Search for the specified value associated with a user\n     * @param user - username to search associated with\n     * @param key - name of the value to retrieve\n     * @returns {Bluebird<string>} - Promise that resolves to the value\n     */\n    public fetchValue(user: string, key: string): Promise<string> {\n        // Retrieve a particular regex from the 1-1 message history of the user\n        const findKey = new RegExp(`My ${key} is (\\\\S+)`, 'i');\n        return this.fetchPrivateMessages(user, findKey).then((valueArray) => {\n            const value = valueArray[valueArray.length - 1].match(findKey);\n            if (value) { return value[1]; }\n            throw new Error(`Could not find value $key for $user`);\n        });\n    }\n\n    /**\n     * Activate this service as a listener\n     */\n    protected activateMessageListener(): void {\n        // Get a list of known flows from the session\n        FlowdockService.session.flows((error: any, flows: any) => {\n            if (error) {\n                throw error;\n            }\n            // Store the names and stream retrieved flows\n            const flowIdToFlowName: {[key: string]: string} = {};\n            for (const flow of flows) {\n                flowIdToFlowName[flow.id] = flow.parameterized_name;\n            }\n            const stream = FlowdockService.session.stream(Object.keys(flowIdToFlowName));\n            // Listen to messages and check they are messages\n            stream.on('message', (message: any) => {\n                if (message.event === 'message') {\n                    // Enqueue new message events\n                    this.queueEvent({\n                        data: {\n                            cookedEvent: {\n                                context: message.thread_id,\n                                flow: flowIdToFlowName[message.flow],\n                                type: message.event,\n                            },\n                            rawEvent: message,\n                            source: this.serviceName,\n                        },\n                        workerMethod: this.handleEvent,\n                    });\n                }\n            });\n        });\n        // Create a keep-alive endpoint for contexts that sleep between web requests\n        MessageService.app.get(`/${this.serviceName}/`, (_formData, response) => {\n            response.send('ok');\n        });\n    }\n\n    /**\n     * Deliver the payload to the service. Sourcing the relevant context has already been performed\n     * @param data - The object to be delivered to the service\n     * @returns {Promise<MessengerEmitResponse>} - Response from the service endpoint\n     */\n    protected sendPayload(data: FlowdockEmitContext): Promise<MessengerEmitResponse> {\n        const body = _.cloneDeep(data);\n        // Extract a couple of details from the environment\n        const org = process.env.FLOWDOCK_ORGANIZATION_NAME;\n        const token = new Buffer(data.token).toString('base64');\n        delete body.token;\n        // Post to the API\n        const requestOpts = {\n            body,\n            headers: {\n                'Authorization': `Basic ${token}`,\n                'X-flowdock-wait-for-message': true,\n            },\n            json: true,\n            url: `https://api.flowdock.com/flows/${org}/${body.flow}/messages/`,\n        };\n        return request.post(requestOpts).then((resData: any) => {\n            // Massage the response into a suitable form for the framework\n            return {\n                response: {\n                    message: resData.id,\n                    thread: resData.thread_id,\n                    url: `https://www.flowdock.com/app/${org}/${body.flow}/threads/${resData.thread_id}`,\n                },\n                source: this.serviceName,\n            };\n        });\n    }\n\n    /**\n     * Search for recent private messages with our account that match on username and regex.\n     * @param username - scope of the private messages to search\n     * @param filter - Narrow our search to just matches\n     * @returns {Bluebird<string[]>} - Promise that resolves to the message strings\n     */\n    private fetchPrivateMessages(username: string, filter: RegExp): Promise<string[]> {\n        // Fetch the id then 1-1 history associated with the username\n        return this.fetchUserId(username)\n        .then((userId) => {\n            return this.fetchFromSession(`/private/${userId}/messages`)\n            .then((fetchedMessages) => {\n                // Prune and clean the message history to text of interest\n                return(_.filter(fetchedMessages, (message: FlowdockMessage) => {\n                    return filter.test(message.content);\n                }).map((message: FlowdockMessage) => {\n                    return message.content;\n                }));\n            });\n        });\n    }\n\n    /**\n     * Fetch a user's id from their username\n     * @param username - username to search for\n     * @returns {Bluebird<string>} - id of the user\n     */\n    private fetchUserId(username: string): Promise<string> {\n        // Get all the users of the service\n        return this.fetchFromSession(`/organizations/${process.env.FLOWDOCK_ORGANIZATION_NAME}/users`)\n        .then((foundUsers) => {\n            // Generate an array of user objects with matching username\n            const matchingUsers = _.filter(foundUsers, (eachUser: any) => {\n                return eachUser.nick === username;\n            });\n            // Return id if we've exactly one user for a particular username\n            if (matchingUsers.length === 1) {\n                return(matchingUsers[0].id);\n            } else {\n                throw new Error('Wrong number of users found in flowdock');\n            }\n        });\n    }\n\n    /**\n     * Utility function to structure the flowdock session as a promise a little\n     * @param path - Endpoint to retrieve\n     * @returns {Bluebird<any>} - response from the session\n     */\n    private fetchFromSession(path: string): Promise<any> {\n        return new Promise<any>((resolve, reject) => {\n            // The flowdock service both emits and calls back the error.\n            // We're wrapping the emit in a promise reject and ignoring the call back\n            FlowdockService.session.on('error', reject);\n            FlowdockService.session.get(path, {}, (_error?: Error, result?: any) => {\n                FlowdockService.session.removeListener('error', reject);\n                if (result) { resolve(result); }\n            });\n        });\n    }\n\n    /**\n     * Get the service name, as required by the framework\n     * @return  The specific service name for Flowdock.\n     */\n    get serviceName(): string {\n        return FlowdockService._serviceName;\n    }\n\n    /**\n     * Retrieve the SDK API handle for Flowdock.\n     * @return  The Flowdock SDK API handle.\n     */\n    get apiHandle(): FlowdockHandle {\n        return {\n            flowdock: FlowdockService.session\n        };\n    }\n}\n\n/**\n * Build this class, typed and activated as a listener\n * @returns {ServiceListener}\n */\nexport function createServiceListener(): ServiceListener {\n    return new FlowdockService(true);\n}\n\n/**\n * Build this class, typed as an emitter\n * @returns {ServiceEmitter}\n */\nexport function createServiceEmitter(): ServiceEmitter {\n    return new FlowdockService(false);\n}\n\n/**\n * Build this class, typed as a message service\n * @returns {MessageService}\n */\nexport function createMessageService(): MessageService {\n    return new FlowdockService(false);\n}\n\n//noinspection JSUnusedGlobalSymbols\n/**\n * Build this class, typed as a data hub\n * @returns {DataHub}\n */\nexport function createDataHub(): DataHub {\n    return new FlowdockService(false);\n}\n"],"sourceRoot":"../../lib"}
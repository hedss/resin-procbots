{"version":3,"sources":["services/front.ts"],"names":[],"mappings":"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","file":"front.js","sourcesContent":["/*\n Copyright 2016-2017 Resin.io\n\n Licensed under the Apache License, Version 2.0 (the \"License\");\n you may not use this file except in compliance with the License.\n You may obtain a copy of the License at\n\n http://www.apache.org/licenses/LICENSE-2.0\n\n Unless required by applicable law or agreed to in writing, software\n distributed under the License is distributed on an \"AS IS\" BASIS,\n WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n See the License for the specific language governing permissions and\n limitations under the License.\n */\n\nimport * as Promise from 'bluebird';\nimport { Conversation, Front } from 'front-sdk';\nimport * as _ from 'lodash';\nimport * as path from 'path';\nimport * as request from 'request-promise';\nimport { FrontEmitContext, FrontHandle } from './front-types';\nimport { Messenger } from './messenger';\nimport { MessengerAction, MessengerEmitResponse, ReceiptContext, TransmitContext } from './messenger-types';\nimport { ServiceEmitter, ServiceEvent, ServiceListener } from './service-types';\n\nexport class FrontService extends Messenger implements ServiceListener, ServiceEmitter {\n    private static _serviceName = path.basename(__filename.split('.')[0]);\n    private static session = new Front(process.env.FRONT_LISTENER_ACCOUNT_API_TOKEN);\n\n    /**\n     * Promise to find the comment history of a particular thread.\n     * @param thread  id of the thread to search.\n     * @param _room   id of the room in which the thread resides.\n     * @param filter  criteria to match.\n     */\n    public fetchNotes(thread: string, _room: string, filter: RegExp): Promise<string[]> {\n        return FrontService.session.conversation.listComments({conversation_id: thread})\n        .then((comments) => {\n            return _.filter(comments._results, (value) => {\n                return filter.test(value.body);\n            }).map((value) => {\n                return value.body;\n            });\n        });\n    }\n\n    /**\n     * Promise to turn the data enqueued into a generic message format.\n     * @param data  Raw data from the enqueue, remembering this is as dumb and quick as possible.\n     * @returns     A promise that resolves to the generic form of the event.\n     */\n    public makeGeneric(data: ServiceEvent): Promise<ReceiptContext> {\n        // Calculate common request details once\n        const getGeneric = {\n            headers: {\n                authorization: `Bearer ${process.env.FRONT_LISTENER_ACCOUNT_API_TOKEN}`\n            },\n            json: true,\n            method: 'GET',\n            uri: '', // Will be over-written\n        };\n        // Make specific forms of the request object for further details\n        const getEvent = _.cloneDeep(getGeneric);\n        getEvent.uri = `https://api2.frontapp.com/events/${data.rawEvent.id}`;\n        const getInboxes = _.cloneDeep(getGeneric);\n        getInboxes.uri = `https://api2.frontapp.com/conversations/${data.rawEvent.conversation.id}/inboxes`;\n        const getMessages = _.cloneDeep(getGeneric);\n        getMessages.uri = `https://api2.frontapp.com/conversations/${data.rawEvent.conversation.id}/messages`;\n        const getComments = _.cloneDeep(getGeneric);\n        getComments.uri = `https://api2.frontapp.com/conversations/${data.rawEvent.conversation.id}/comments`;\n        // Gather further details of the enqueued event\n        return Promise.props({\n            comments: request(getComments),\n            event: request(getEvent),\n            inboxes: request(getInboxes),\n            messages: request(getMessages),\n        })\n        .then((details: {comments: any, event: any, inboxes: any, messages: any}) => {\n            // Pre-calculate a couple of values, to save line width\n            const message = details.event.target.data;\n            const first = details.comments._results.length + details.messages._results.length === 1;\n            const metadata = Messenger.extractMetadata(message.text || message.body);\n            // Attempt to find the author of a message from the various places front might store it\n            let author = 'Unknown';\n            if (message.author) {\n                author = message.author.username;\n            } else {\n                for (const recipient of message.recipients) {\n                    if (recipient.role === 'from') {\n                        author = recipient.handle;\n                    }\n                }\n            }\n            // Return the generic form of this event\n            return {\n                action: MessengerAction.Create,\n                first,\n                genesis: metadata.genesis || data.source || FrontService._serviceName,\n                hidden: first ? metadata.hidden : details.event.type === 'comment',\n                source: FrontService._serviceName,\n                sourceIds: {\n                    flow: details.inboxes._results[0].id,\n                    message: message.id,\n                    thread: details.event.conversation.id,\n                    url: `https://app.frontapp.com/open/${details.event.conversation.id}`,\n                    user: author,\n                },\n                text: metadata.content,\n                title: details.event.conversation.subject,\n            };\n        });\n    }\n\n    /**\n     * Promise to turn the generic message format into a specific form to be emitted.\n     * @param data  Generic message format object to be encoded.\n     * @returns     Promise that resolves to the emit suitable form.\n     */\n    public makeSpecific(data: TransmitContext): Promise<FrontEmitContext> {\n        // Attempt to find the thread ID to know if this is a new conversation or not\n        const conversationId = data.toIds.thread;\n        if (!conversationId) {\n            // Find the title and user ID for the event\n            const subject = data.title;\n            if (!subject) {\n                throw new Error('Cannot create Front Conversation without a title');\n            }\n            return this.fetchUserId(data.toIds.user).then((userId) => {\n                // The specific form that may be emitted\n                return {\n                    endpoint: {\n                        method: this.apiHandle.front.message.send,\n                    },\n                    payload: {\n                        author_id: userId,\n                        body: `${data.text}\\n\\n---\\n${Messenger.stringifyMetadata(data, 'plaintext')}`,\n                        // Find the relevant channel for the inbox\n                        channel_id: JSON.parse(process.env.FRONT_INBOX_CHANNELS)[data.toIds.flow],\n                        metadata: {\n                            thread_ref: data.sourceIds.thread,\n                        },\n                        options: {\n                            archive: false,\n                        },\n                        sender: {\n                            handle: data.toIds.user,\n                        },\n                        subject,\n                        to: [data.sourceIds.user],\n                    }\n                };\n            });\n        }\n        return Promise.props({\n            conversation: FrontService.session.conversation.get({conversation_id: conversationId}),\n            userId: this.fetchUserId(data.toIds.user)\n        }).then((details: {conversation: Conversation, userId: string}) => {\n            if (data.hidden) {\n                return {\n                    endpoint: {\n                        method: this.apiHandle.front.comment.create,\n                    },\n                    payload: {\n                        author_id: details.userId,\n                        body: `${data.text}\\n\\n---\\n${Messenger.stringifyMetadata(data, 'plaintext')}`,\n                        conversation_id: conversationId,\n                    }\n                };\n            }\n            return {\n                endpoint: {\n                    method: this.apiHandle.front.message.reply,\n                },\n                payload: {\n                    author_id: details.userId,\n                    body: `${data.text}\\n\\n---\\n${Messenger.stringifyMetadata(data, 'plaintext')}`,\n                    conversation_id: conversationId,\n                    options: {\n                        archive: false,\n                    },\n                    subject: details.conversation.subject,\n                    type: data.hidden ? 'comment' : 'message',\n                }\n            };\n        });\n    }\n\n    /**\n     * Turns the generic, messenger, name for an event into a specific trigger name for this class.\n     * @param eventType  Name of the event to translate, eg 'message'.\n     * @returns          This class's equivalent, eg 'post'.\n     */\n    public translateEventName(eventType: string): string {\n        const equivalents: {[key: string]: string} = {\n            message: 'event',\n        };\n        return equivalents[eventType];\n    }\n\n    /**\n     * Activate this service as a listener.\n     */\n    protected activateMessageListener(): void {\n        // This swallows response attempts to the channel, since we notice them on the inbox instead\n        Messenger.app.post('/front-dev-null', (_formData, response) => {\n            response.send(200);\n        });\n        // Create an endpoint for this listener and enqueue events\n        Messenger.app.post(`/${FrontService._serviceName}/`, (formData, response) => {\n            this.queueEvent({\n                data: {\n                    cookedEvent: {\n                        context: formData.body.conversation.id,\n                        type: 'event',\n                    },\n                    rawEvent: formData.body,\n                    source: FrontService._serviceName,\n                },\n                workerMethod: this.handleEvent,\n            });\n            response.send(200);\n        });\n    }\n\n    /**\n     * Deliver the payload to the service. Sourcing the relevant context has already been performed.\n     * @param data  The object to be delivered to the service.\n     * @returns     Response from the service endpoint.\n     */\n    protected sendPayload(data: FrontEmitContext): Promise<MessengerEmitResponse> {\n        return data.method(data.payload).then(() => {\n            if(data.payload.conversation_id) {\n                return Promise.resolve({\n                    response: {\n                        message: `${data.payload.author_id}:${new Date().getTime()}`,\n                        thread: data.payload.conversation_id,\n                        url: `https://app.frontapp.com/open/${data.payload.conversation_id}`,\n                    },\n                    source: FrontService._serviceName,\n                });\n            }\n            return this.findConversation(data.payload.subject)\n            .then((conversationId) => {\n                return {\n                    response: {\n                        message: `${data.payload.author_id}:${new Date().getTime()}`,\n                        thread: conversationId,\n                        url: `https://app.frontapp.com/open/${conversationId}`,\n                    },\n                    source: FrontService._serviceName,\n                };\n            });\n        });\n    }\n\n    /**\n     * Find the ID of a user specified by username.\n     * @param username  target username to search for.\n     * @returns         Promise that resolves to the user id.\n     */\n    private fetchUserId(username: string): Promise<string> {\n        // Request a list of all teammates\n        const getTeammates = {\n            headers: {\n                authorization: `Bearer ${process.env.FRONT_LISTENER_ACCOUNT_API_TOKEN}`\n            },\n            json: true,\n            method: 'GET',\n            uri: 'https://api2.frontapp.com/teammates',\n        };\n        return request(getTeammates).then((teammates: {_results: Array<{username: string, id: string}>}) => {\n            // Resolve to the ID of the first matching teammate\n            const teammate = _.find(teammates._results, (eachTeammate) => {\n                return eachTeammate.username === username;\n            });\n            if (teammate) {\n                return teammate.id;\n            }\n            throw new Error('No teammate found for specified username');\n        });\n    }\n\n    /**\n     * Attempt to find a recent conversation ID from it's subject line.\n     * Done by subject because the conversation_reference provided is sometimes junk.\n     * @param subject       target subject line to search for.\n     * @param attemptsLeft  Since conversations take time to propagate this method may recurse.\n     * @returns             Promise that resolves to the ID of the conversation.\n     */\n    private findConversation(subject: string, attemptsLeft: number = 10): Promise<string> {\n        // Find all the recent conversations\n        return FrontService.session.conversation.list().then((response) => {\n            // Filter these down to matching conversations\n            const conversationsMatched = _.filter(response._results, (conversation) => {\n                return conversation.subject === subject;\n            });\n            // Return the most recent, if any\n            if (conversationsMatched.length > 0) {\n                return conversationsMatched[0].id;\n            }\n            // Recurse up to the specified number of times\n            if (attemptsLeft > 1) {\n                return this.findConversation(subject, attemptsLeft - 1);\n            }\n            throw new Error('Could not find relevant conversation.');\n        });\n    }\n\n    /**\n     * The name of this service, as required by the framework.\n     * @returns {string}  'flowdock'.\n     */\n    get serviceName(): string {\n        return FrontService._serviceName;\n    }\n\n    /**\n     * Retrieve the SDK API handle for Front.\n     * @return  The Front SDK API handle.\n     */\n    get apiHandle(): FrontHandle {\n        return {\n            front: FrontService.session\n        };\n    }\n}\n\n/**\n * Build this class, typed and activated as a listener.\n * @returns  Service Listener object, awakened and ready to go.\n */\nexport function createServiceListener(): ServiceListener {\n    return new FrontService(true);\n}\n\n/**\n * Build this class, typed as an emitter.\n * @returns  Service Emitter object, ready for your events.\n */\nexport function createServiceEmitter(): ServiceEmitter {\n    return new FrontService(false);\n}\n\n/**\n * Build this class, typed as a message service.\n * @returns  Message Service object, ready to convert events.\n */\nexport function createMessageService(): Messenger {\n    return new FrontService(false);\n}\n"],"sourceRoot":"../../lib"}